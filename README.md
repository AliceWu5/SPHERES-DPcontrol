# SPHERES - Dynamic Programming Control ![MATLABver](https://img.shields.io/badge/MATLAB-v9.1%2B-orange.svg) ![MATLAB16b](https://img.shields.io/badge/MATLAB-R2016b-yellow.svg) ![MATLAB17](https://img.shields.io/badge/MATLAB-R2017-green.svg) 

This repository contains code for simulation and control of a *[SPHERES](https://www.nasa.gov/spheres/home
)* satellite in formation with another satellite, using a vectorized Dynamic Programming approach. Made available publicly, mainly to reproduce the work of a article that is currently in progress.

## How it works
<p align="center"><img width=43% src="https://raw.githubusercontent.com/abdolrezat/SPHERES-DPcontrol/master/figures/reference frame.png"></p>

Starting from the initial conditions at t = 0, the simulator runs every 5 milliseconds and computes new state and control vectors. In each instance, the [Clohessy-Wiltshire equations](https://en.wikipedia.org/wiki/Clohessy-Wiltshire_equations
) of relative motion are used to update the position of a target satellite A and to determine the relative position of the *SPHERES* satellite B that is following satellite A (in RSW frame of reference - see figure above from *Curtis*). The [Euler's rotation equations](https://en.wikipedia.org/wiki/Euler%27s_equations_(rigid_body_dynamics)) are used as well, to update quaternions and angular velocities of the *SPHERES* satellite (in Body frame). The equations of position and attitude are inevitably coupled because some state variables are shared in both. The CW equations of relative motion are not simplified for circular orbits, so the complete equations are as follows:

<p align="left"><img width=65% src="https://raw.githubusercontent.com/abdolrezat/SPHERES-DPcontrol/master/figures/CW equations.png"></p>

Dynamic Programming is used to generate controllers (will be explained in detail in later sections), these controllers are preloaded into the satellite, and help determine the optimal forces and moments that the *SPHERES* satellite requires to reach the target satellite. These required forces and moments are then converted to thruster on-off commands, using a control allocation method (will be explained in detail) such as a [Pulse-Width Pulse-Frequency (PWPF) Modulator](http://smsl.egr.uh.edu/sites/smsl/files/files/publications/Song_Attitude_Control_PWPFSpace_Technology_1997.pdf), a [Schmitt trigger](https://en.wikipedia.org/wiki/Schmitt_trigger) or the [Active Set Method](https://ccom.ucsd.edu/~elwong/p/elw-thesis.pdf
). After the command for all 12 thrusters are determined, the simulator recalculates all forces and moments in their respective frames, and continues the simulation to calculate the next states from the previous states and actions. Differential equations are solved using the *fourth-order Runge-Kutta* method (since the time steps are in order of milliseconds, there is no difference in the results of RK4 and ODE45, however, RK4 is significantly faster). The overall process of the simulation is shown in the figure below:

<p align="center"><img width=100% src="https://raw.githubusercontent.com/abdolrezat/SPHERES-DPcontrol/master/figures/Simulation.jpg"></p>

## Run the Tests

You can simply run the scripts to see the results. In addition, you may change the controller configurations and/or initial conditions to see how the satellite controls itself under different conditions. The script below is set with initial conditions of -0.6 meters offset in x, y, and z directions and 10 degree offset in angles. Control allocation method is set to "Active Set", additional information can be read inside the script:

```
%%% for Dynamic Programming Control
closedist_normal_activeset_allocation
```

If you want to see control with Proportional-Differential controllers in the same condition, run the script below:

```
closedist_normal_PD_controller_activeset
```

- Note: PD means *Proportional-Differential*, not to be confused with DP (Dynamic Programming), see inside each script for initial conditions and configurations. 

### Results

After you run the scripts, you can see how states have changed and actions taken during the entire simulation. For the example above, fuel consumption using Dynamic Programming is **23% less than** PD control in only 0.6 meters of displacement. The Kp and Kd parameters for the PD controller are chosen so that both trajectories have similar settling times. The position plots in z-direction are as follows:

<p align="center"><img width=90% src="https://raw.githubusercontent.com/abdolrezat/SPHERES-DPcontrol/master/figures/Xdiff.png"></p>


### Control Allocation Schemes

The control allocation methods determine on/offs for each thruster in order to reach the nearest torques and forces in 3DOF generated by Dynamic Programming or PD controller. In other words, the forces and torques that are required to control the satellite are converted to thruster firings by the control allocation systems. There are several allocation methods defined in the simulator, one of which is the Active Set Method:

#### Active Set Method

The [*Active Set Method*](https://ccom.ucsd.edu/~elwong/p/elw-thesis.pdf) here is the problem of finding the set of thruster firings (on/offs) that minimize the following quadratic cost function (from [here](ssl.mit.edu/publications/theses/SM-2010-PongChristopher.pdf
))

<p align="left"><img width=45% src="https://raw.githubusercontent.com/abdolrezat/SPHERES-DPcontrol/master/figures/Quad Prog.png"></p>

The numerical algorithms explained in some references seem quite complex to find the multi-variable answer to this problem, especially when a continuous range of values and many variables are involved. However, since SPHERES is an all-thruster satellite and the thrusters can only produce a fixed amount of force, finding the solution in this particular case is super easy. First, using the `all_feasible_thruster_u` function, all the possible combinations of thruster on/offs are generated for each channel of 4 thrusters. Next, each combination is put directly as `u` in the above cost function, and the minimum set is easily found by using MATLAB's `min` function and extracting the `id` of the set. 

In each channel, when all 4 thrusters are operational, 16 (=2^4) total combinations of thruster firings are present. However, not all combinations are efficient in terms of fuel consumption. In other words, some combinations produce the same amount of forces and torques, but one of them uses less fuel in the process. This happens particularly when two thrusters in the opposite directions fire and cancel out each other. For instance, consider the case where all four thrusters fire in one channel, they all cancel each other out and produce zero force and torque in their directions, which is the same as the more fuel efficient set of all thrusters being off. Crossing out these cases not only results in more fuel efficiency but also makes the computations very efficient, too.

Additionally, this allocation method supports the scenario of faulty thruster(s). If the IDs of the faulty thrusters are determined, the combinations are automatically reduced to those in which the faulty thrusters are always "off".


## Acknowledgments

This work wouldn't have been possible without exceptional support and guidance provided by [Dr. Nima Assadian](http://ae.sharif.edu/~web/homepage.php?username=assadian) of the Aerospace Engineering Department at Sharif University of Technology, who was the supervisor of the project.

## License

This project is licensed under the [MIT License](LICENSE.md) - Author: [**Abdolreza Taheri**](https://www.researchgate.net/profile/Abdolreza_Taheri)
